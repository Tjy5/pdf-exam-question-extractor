# PDFè¯•å·è‡ªåŠ¨åˆ‡é¢˜ä¸ç»“æ„åŒ–å·¥å…· v2.0

![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)
![PaddleOCR](https://img.shields.io/badge/PaddleOCR-3.x-green.svg)
![License](https://img.shields.io/badge/license-MIT-orange.svg)

ä¸€ä¸ªåŸºäº **PaddleOCR + PP-StructureV3** çš„æ™ºèƒ½è¯•å·å¤„ç†å·¥å…·ï¼Œå¯è‡ªåŠ¨å°† PDF è¯•å·åˆ‡åˆ†æˆå•ä¸ªé¢˜ç›®å›¾ç‰‡ï¼Œå¹¶æå–æ–‡å­—å’Œè¡¨æ ¼ç»“æ„ã€‚

---

## âœ¨ ç‰¹æ€§

- ğŸ¯ **æ™ºèƒ½è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«é¢˜å·ã€å¤§é¢˜æ ‡é¢˜ã€è·¨é¡µç»­æ¥
- ğŸ“Š **ç»“æ„åŒ–è¾“å‡º**: ç”ŸæˆJSONæ ¼å¼çš„é¢˜ç›®å…ƒæ•°æ®
- ğŸ–¼ï¸ **é«˜è´¨é‡åˆ‡å›¾**: æ™ºèƒ½è£å‰ªè¾¹ç•Œï¼Œæ”¯æŒé•¿å›¾æ‹¼æ¥
- ğŸ“ˆ **èµ„æ–™åˆ†æ**: ç‰¹æ®Šå¤„ç†èµ„æ–™åˆ†æå¤§é¢˜
- ğŸŒ **åŒæ¨¡å¼**: æ”¯æŒCLIå‘½ä»¤è¡Œå’ŒWebç•Œé¢
- âš™ï¸ **å¯é…ç½®**: YAMLé…ç½®æ–‡ä»¶ç®¡ç†ä¸åŒè¯•å·å‚æ•°

---

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

> **æ³¨æ„**: PaddleOCR ä¼šæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹© CPU/GPU ç‰ˆæœ¬ã€‚å›½å†…ç”¨æˆ·å»ºè®®ä½¿ç”¨æ¸…åé•œåƒæºï¼š
> ```bash
> pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
> ```

### 2. å¿«é€Ÿä½“éªŒ

```bash
# å¯åŠ¨CLIäº¤äº’å¼èœå•ï¼ˆæ¨èæ–°æ‰‹ï¼‰
python manage.py

# æˆ–è€…å¯åŠ¨Webç•Œé¢
python manage.py web
# ç„¶åè®¿é—® http://127.0.0.1:8000
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### CLIæ¨¡å¼ï¼ˆå‘½ä»¤è¡Œï¼‰

```bash
# å¯åŠ¨äº¤äº’å¼èœå•
python manage.py cli

# å¤„ç†å•ä¸ªPDFï¼ˆå¼€å‘ä¸­ï¼‰
python manage.py process input.pdf --config config/exam_gd_2025.yaml

# æ‰¹é‡å¤„ç†ç›®å½•ï¼ˆå¼€å‘ä¸­ï¼‰
python manage.py batch ./pdfs/
```

### Webæ¨¡å¼ï¼ˆç½‘é¡µç•Œé¢ï¼‰

```bash
# å¯åŠ¨WebæœåŠ¡å™¨ï¼ˆæ¨èï¼‰
python manage.py web

# Windowså¿«æ·å¯åŠ¨
start_web.bat

# è‡ªå®šä¹‰ç«¯å£
python manage.py web --port 9000

# è°ƒè¯•æ¨¡å¼
python manage.py web --debug
```

> **æç¤º**: Windowsç”¨æˆ·å¯ç›´æ¥åŒå‡» `start_web.bat` å¯åŠ¨Webç•Œé¢

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
newvl/
â”œâ”€â”€ src/                      # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ common/               # å…¬å…±æ¨¡å—ï¼ˆå·²æ¨¡å—åŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ types.py          # å¸¸é‡å’Œç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ paths.py          # è·¯å¾„å·¥å…·
â”‚   â”‚   â”œâ”€â”€ io.py             # æ–‡ä»¶IO
â”‚   â”‚   â”œâ”€â”€ image.py          # å›¾ç‰‡å¤„ç†
â”‚   â”‚   â”œâ”€â”€ ocr_models.py     # OCRæ¨¡å‹ç®¡ç†
â”‚   â”‚   â””â”€â”€ utils.py          # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒç®—æ³•ï¼ˆå¾…å®ç°ï¼‰
â”‚   â”œâ”€â”€ ocr/                  # OCRå°è£…
â”‚   â”œâ”€â”€ postprocess/          # åå¤„ç†
â”‚   â”œâ”€â”€ compose/              # é•¿å›¾æ‹¼æ¥
â”‚   â”œâ”€â”€ analysis/             # æ•°æ®åˆ†æ
â”‚   â”œâ”€â”€ services/             # æœåŠ¡å±‚ï¼ˆå¾…å®ç°ï¼‰
â”‚   â”œâ”€â”€ config/               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ cli/                  # CLIé€»è¾‘
â”‚   â””â”€â”€ web/                  # Webåç«¯
â”œâ”€â”€ scripts/                  # è¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ archived/             # å½’æ¡£çš„å®éªŒä»£ç 
â”‚   â””â”€â”€ migrate_data_v1_to_v2.py  # æ•°æ®è¿ç§»å·¥å…·
â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ global_settings.yaml  # å…¨å±€é»˜è®¤é…ç½®
â”‚   â”œâ”€â”€ exam_gd_2025.yaml     # å¹¿ä¸œçœè€ƒé…ç½®
â”‚   â””â”€â”€ exam_sihai_2025.yaml  # å››æµ·å¥—é¢˜é…ç½®
â”œâ”€â”€ data/                     # æ•°æ®ç›®å½•ï¼ˆä¸å…¥Gitï¼‰
â”‚   â”œâ”€â”€ input/                # è¾“å…¥PDF
â”‚   â”œâ”€â”€ interim/              # ä¸­é—´æ–‡ä»¶
â”‚   â”œâ”€â”€ output/               # å¤„ç†ç»“æœ
â”‚   â”‚   â”œâ”€â”€ gd_2025/
â”‚   â”‚   â”‚   â”œâ”€â”€ pages/        # æ•´é¡µå›¾ç‰‡
â”‚   â”‚   â”‚   â”œâ”€â”€ questions/    # åˆ‡å¥½çš„é¢˜ç›®
â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ cache/                # ç¼“å­˜
â”œâ”€â”€ tests/                    # æµ‹è¯•ç”¨ä¾‹
â”‚   â””â”€â”€ fixtures/             # æµ‹è¯•æ•°æ®ï¼ˆå°æ ·æœ¬ï¼‰
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md             # æ—§ç‰ˆè¯¦ç»†æ–‡æ¡£
â”‚   â””â”€â”€ PaddleOCRå®Œæ•´ä½¿ç”¨æŒ‡å—.md
â”œâ”€â”€ web_interface/            # Webå‰ç«¯
â”‚   â”œâ”€â”€ app.py                # FastAPIåº”ç”¨ï¼ˆ5æ­¥å¤„ç†æµç¨‹ï¼‰
â”‚   â””â”€â”€ templates/            # ç½‘é¡µæ¨¡æ¿
â”œâ”€â”€ manage.py                 # ç»Ÿä¸€ç¨‹åºå…¥å£ â­
â”œâ”€â”€ start_web.bat             # Windows Webå¯åŠ¨è„šæœ¬
â”œâ”€â”€ common.py                 # å‘åå…¼å®¹æ¨¡å—ï¼ˆâš ï¸ å·²å¼ƒç”¨ï¼‰
â”œâ”€â”€ extract_questions_ppstruct.py  # é¢˜ç›®æå–ä¸»è„šæœ¬
â”œâ”€â”€ make_data_analysis_big.py      # èµ„æ–™åˆ†æå¤„ç†
â”œâ”€â”€ compose_question_long_image.py # é•¿å›¾æ‹¼æ¥
â”œâ”€â”€ requirements.txt
â””â”€â”€ .gitignore
```

---

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### é…ç½®æ–‡ä»¶å±‚çº§

```
å…¨å±€é…ç½® (config/global_settings.yaml)
    â†“ è¢«è¦†ç›–
è¯•å·é…ç½® (config/exam_*.yaml)
    â†“ è¢«è¦†ç›–
å‘½ä»¤è¡Œå‚æ•°
```

### ä¸ºæ–°è¯•å·åˆ›å»ºé…ç½®

1. å¤åˆ¶ `config/exam_gd_2025.yaml` ä½œä¸ºæ¨¡æ¿
2. ä¿®æ”¹ `exam_info` éƒ¨åˆ†ï¼š
   ```yaml
   exam_info:
     id: my_exam_2025          # å”¯ä¸€æ ‡è¯†
     name: "æˆ‘çš„è¯•å·åç§°"
     description: "ç®€è¦æè¿°"
   ```
3. è°ƒæ•´ç‰¹å®šå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼š
   ```yaml
   extraction:
     margin_ratio: 0.010  # å¦‚æœéœ€è¦æ›´å¤§çš„è£å‰ªè¾¹è·
   ```

---

## ğŸ”„ æ•°æ®è¿ç§»ï¼ˆv1 â†’ v2ï¼‰

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨è¿‡æ—§ç‰ˆæœ¬ï¼Œéœ€è¦è¿ç§» `pdf_images/` æ•°æ®ï¼š

```bash
# å…ˆæ¨¡æ‹Ÿè¿è¡Œï¼ŒæŸ¥çœ‹è¿ç§»è®¡åˆ’
python scripts/migrate_data_v1_to_v2.py --dry-run

# ç¡®è®¤æ— è¯¯åæ‰§è¡Œè¿ç§»
python scripts/migrate_data_v1_to_v2.py

# è¿ç§»åéªŒè¯
python manage.py cli
# åœ¨èœå•ä¸­é€‰æ‹©"æŸ¥çœ‹å·²å¤„ç†è¯•å·åˆ—è¡¨"
```

**è¿ç§»åæ•°æ®ä½ç½®**: `data/output/{exam_id}/`

---

## ğŸ“ å·¥ä½œæµç¨‹

```
1. PDF â†’ images      (pdf_to_images.py)
    â†“
2. ç‰ˆé¢åˆ†æ         (extract_questions_ppstruct.py)
    â†“
3. é¢˜ç›®æå–         è‡ªåŠ¨è¯†åˆ«é¢˜å·ã€è£å‰ª
    â†“
4. èµ„æ–™åˆ†æå¤„ç†     (make_data_analysis_big.py)
    â†“
5. é•¿å›¾æ‹¼æ¥         (compose_question_long_image.py)
    â†“
6. Webå±•ç¤º          (manage.py web)
```

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. æ¨¡å‹ä¸‹è½½å¤±è´¥

**é—®é¢˜**: é¦–æ¬¡è¿è¡Œæ—¶ PaddleOCR å°è¯•ä¸‹è½½æ¨¡å‹ä½†å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- ç¦»çº¿æ¨¡å‹è·¯å¾„: `~/.paddlex/official_models`
- æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹å¹¶æ”¾ç½®åˆ°è¯¥ç›®å½•
- æˆ–ä½¿ç”¨ä»£ç†: `export https_proxy=http://127.0.0.1:7890`

### 2. ä¸­æ–‡è·¯å¾„é—®é¢˜

**é—®é¢˜**: Windows ä¸Šä¸­æ–‡è·¯å¾„å¯¼è‡´ç¼–ç é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- å°†é¡¹ç›®æ”¾åœ¨è‹±æ–‡è·¯å¾„ä¸‹
- æˆ–åœ¨è„šæœ¬å¼€å¤´æ·»åŠ :
  ```python
  import sys
  sys.stdout.reconfigure(encoding='utf-8')
  ```

### 3. GPU ç›¸å…³é”™è¯¯

**é—®é¢˜**: æç¤º CUDA ç›¸å…³é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- å®‰è£… CPU ç‰ˆæœ¬: `pip install paddlepaddle`
- æˆ–åœ¨é…ç½®æ–‡ä»¶ä¸­ç¦ç”¨ GPU:
  ```yaml
  ocr:
    gpu_enable: false
  ```

### 4. Webç•Œé¢"ç»“æœæ±‡æ€»"æ­¥éª¤æ— æ³•å¤åˆ¶é¢˜ç›®å›¾ç‰‡

**é—®é¢˜**: æ­¥éª¤4å®Œæˆå `all_questions` ç›®å½•ä¸ºç©ºæˆ–ç¼ºå°‘é¢˜ç›®

**åŸå› **: meta.json ä¸­çš„è·¯å¾„åŒ…å«æ—§ç›®å½•åï¼ˆå¦‚ `_v2` åç¼€ï¼‰ï¼Œä½†å®é™…ç›®å½•å·²é‡å‘½å

**è§£å†³æ–¹æ¡ˆ**:
- âœ… **å·²åœ¨ v2.0.1 ä¿®å¤**: `src/common/paths.py` çš„ `resolve_image_path` å‡½æ•°ç°åœ¨æ”¯æŒç›®å½•é‡å‘½ååçš„è·¯å¾„è‡ªåŠ¨ä¿®å¤
- å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ meta.json ä¸­çš„ `image` å­—æ®µæ ¼å¼

---

## âš ï¸ é‡è¦æç¤º

### å¼ƒç”¨è­¦å‘Š

- **`common.py`** (æ ¹ç›®å½•): è¯¥æ–‡ä»¶ä»…ç”¨äºå‘åå…¼å®¹ï¼Œæ–°ä»£ç è¯·ä½¿ç”¨:
  ```python
  # æ—§ä»£ç ï¼ˆä¸æ¨èï¼‰
  from common import get_ppstructure, load_meta

  # æ–°ä»£ç ï¼ˆæ¨èï¼‰
  from src.common import get_ppstructure, load_meta
  from src.common.paths import resolve_image_path  # æ”¯æŒè·¯å¾„ä¿®å¤
  ```

- **`cli_menu.py`**: å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨ `manage.py cli` æˆ– Web ç•Œé¢

### Git ç®¡ç†

- **ä¸è¦æäº¤**: `data/`ã€`pdf_images/`ã€`*.png`ã€`*.pdf`
- **åº”è¯¥æäº¤**: `tests/fixtures/` ä¸­çš„å°æ ·æœ¬æ•°æ®
- **é…ç½®æ–‡ä»¶**: `config/*_local.yaml` å’Œ `chatocr_config_local.json` ä¸å…¥åº“

---

## ğŸ§ª å¼€å‘æŒ‡å—

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_common.py
```

### æ·»åŠ æ–°åŠŸèƒ½

1. åœ¨ `src/` å¯¹åº”æ¨¡å—ä¸‹å®ç°åŠŸèƒ½
2. æ·»åŠ é…ç½®é¡¹åˆ° `config/global_settings.yaml`
3. åœ¨ `manage.py` ä¸­æ·»åŠ å‘½ä»¤ï¼ˆå¦‚éœ€è¦ï¼‰
4. ç¼–å†™æµ‹è¯•
5. æ›´æ–°æ–‡æ¡£

---

## ğŸ“š æ›´å¤šæ–‡æ¡£

- [æ—§ç‰ˆè¯¦ç»†æ–‡æ¡£](docs/README.md) - v1.x çš„å®Œæ•´è¯´æ˜
- [PaddleOCRä½¿ç”¨æŒ‡å—](docs/PaddleOCRå®Œæ•´ä½¿ç”¨æŒ‡å—.md) - OCRå¼•æ“è¯¦è§£
- [Webä½¿ç”¨æŒ‡å—](WEB_ä½¿ç”¨æŒ‡å—.md) - Webç•Œé¢æ“ä½œè¯´æ˜ï¼ˆå¦‚å­˜åœ¨ï¼‰

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­æå‡ºã€‚

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0.1 (2025-12-12)

**ä¿®å¤**:
- ğŸ› ä¿®å¤è·¯å¾„è§£æbugï¼šmeta.json è·¯å¾„åŒ…å«æ—§ç›®å½•åæ—¶æ— æ³•æ‰¾åˆ°æ–‡ä»¶ (`src/common/paths.py`)
- ğŸ› ä¼˜åŒ–èµ„æ–™åˆ†æå¤§é¢˜æ‹¼æ¥ï¼šå¢åŠ ææ–™ä¸é¢˜ç›®é—´éš™è‡³200px (`make_data_analysis_big.py`)
- ğŸ§¹ ç§»é™¤ç‹¬ç«‹ CLI å·¥å…· `cli_menu.py`ï¼Œç»Ÿä¸€ä½¿ç”¨ Web ç•Œé¢

**æ”¹è¿›**:
- âœ¨ `resolve_image_path` æ”¯æŒè·¨å¹³å°è·¯å¾„åˆ†éš”ç¬¦å’Œç›®å½•é‡å‘½å
- âœ¨ Windows å¿«æ·å¯åŠ¨è„šæœ¬ `start_web.bat`

### v2.0.0 (2025-12-11)

**é‡æ„**:
- æ¨¡å—åŒ– `src/common/` ç›®å½•
- é…ç½®ç³»ç»Ÿ `config/*.yaml`
- ç»Ÿä¸€å…¥å£ `manage.py`

---

**ç‰ˆæœ¬**: v2.0.1
**æœ€åæ›´æ–°**: 2025-12-12
